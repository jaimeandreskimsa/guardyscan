// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionPlan {
  FREE
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

enum ScanStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ScanType {
  BASIC
  FULL
  COMPLIANCE
  VULNERABILITY
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String
  image         String?
  company       String?
  role          String    @default("user")
  resetToken    String?
  resetTokenExpiry DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  subscription  Subscription?
  scans         Scan[]
  incidents     Incident[]
  pdfPurchases  PdfPurchase[]
  committeeMembers CommitteeMember[]
  securityEvents SecurityEvent[]
  securityAlerts SecurityAlert[]
  detectionRules DetectionRule[]
  userBehaviors UserBehavior[]
  riskAssessments RiskAssessment[]
  businessImpactAnalyses BusinessImpactAnalysis[]
  thirdPartyRisks ThirdPartyRisk[]
  monteCarloSimulations MonteCarloSimulation[]
  vulnerabilities Vulnerability[]
  businessContinuityPlans BusinessContinuityPlan[]
  
  // Organization relations
  ownedOrganizations Organization[]
  organizationMemberships OrganizationMember[]

  @@map("users")
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  logo        String?
  website     String?
  industry    String?
  size        String?  // "1-10", "11-50", "51-200", "201-500", "500+"
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  members     OrganizationMember[]
  invitations OrganizationInvitation[]

  @@index([ownerId])
  @@index([createdAt])
  @@map("organizations")
}

model OrganizationMember {
  id             String           @id @default(cuid())
  organizationId String
  userId         String
  role           OrganizationRole @default(MEMBER)
  joinedAt       DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([organizationId])
  @@map("organization_members")
}

model OrganizationInvitation {
  id             String           @id @default(cuid())
  organizationId String
  email          String
  role           OrganizationRole @default(MEMBER)
  token          String           @unique
  expiresAt      DateTime
  createdAt      DateTime         @default(now())

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([expiresAt])
  @@map("organization_invitations")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Subscription {
  id               String             @id @default(cuid())
  userId           String             @unique
  plan             SubscriptionPlan   @default(FREE)
  status           SubscriptionStatus @default(ACTIVE)
  stripeCustomerId String?            @unique
  stripeSubscriptionId String?        @unique
  stripePriceId    String?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean          @default(false)
  scansUsed        Int                @default(0)
  scansLimit       Int                @default(3) // FREE: 3, BASIC: 50, PROFESSIONAL: 200, ENTERPRISE: unlimited
  
  // Auto-scan configuration
  autoScanEnabled  Boolean            @default(false)
  autoScanUrl      String?
  lastAutoScan     DateTime?
  
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Scan {
  id          String     @id @default(cuid())
  userId      String
  targetUrl   String
  scanType    ScanType   @default(BASIC)
  status      ScanStatus @default(PENDING)
  progress    Int        @default(0) // Progress percentage 0-100
  results     Json?
  score       Int?       // Security score 0-100
  createdAt   DateTime   @default(now())
  completedAt DateTime?

  // Detailed results
  sslInfo         Json? // Certificate details
  securityHeaders Json? // Security headers analysis
  vulnerabilities Json? // Found vulnerabilities
  technologies    Json? // Detected technologies
  dnsRecords      Json? // DNS information
  whoisData       Json? // Domain information
  openPorts       Json? // Open ports scan
  compliance      Json? // ISO 27001, GDPR compliance checks
  performance     Json? // Performance metrics
  configFiles     Json? // Configuration files found
  cookies         Json? // Cookie analysis
  firewall        Json? // Firewall/WAF detection

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  pdfPurchases PdfPurchase[]

  @@index([userId])
  @@map("scans")
}

model PdfPurchase {
  id                String   @id @default(cuid())
  userId            String
  scanId            String
  amount            Int      // Amount in cents
  stripePaymentId   String   @unique
  pdfUrl            String?  // S3 or storage URL
  createdAt         DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  scan Scan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([scanId])
  @@map("pdf_purchases")
}

model Incident {
  id          String           @id @default(cuid())
  userId      String
  title       String
  description String
  severity    IncidentSeverity
  status      IncidentStatus   @default(OPEN)
  category    String           // e.g., "Data Breach", "Phishing", "Malware"
  affectedSystems String?
  assignedTo  String?          // Responsible person
  detectedAt  DateTime         @default(now())
  resolvedAt  DateTime?
  closedAt    DateTime?        // Closing date
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("incidents")
}

// Legacy compliance model - kept for backwards compatibility
model ComplianceControlLegacy {
  id            String   @id @default(cuid())
  framework     String   // "ISO27001", "GDPR", "SOC2"
  controlId     String   // e.g., "A.8.1.1"
  controlName   String
  description   String
  category      String
  implemented   Boolean  @default(false)
  evidence      String?
  notes         String?
  lastReviewed  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([framework, controlId])
  @@map("compliance_controls_legacy")
}

model CommitteeMember {
  id              String   @id @default(cuid())
  userId          String
  name            String
  role            String   // "CISO", "Security Officer", "Board Member", etc.
  email           String
  phone           String?
  department      String?
  responsibilities String?  @db.Text
  appointedDate   DateTime @default(now())
  status          String   @default("ACTIVE") // "ACTIVE", "INACTIVE"
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("committee_members")
}

// SIEM - Security Information and Event Management
model SecurityEvent {
  id              String   @id @default(cuid())
  userId          String
  eventType       String   // "login", "file_access", "network", "malware", "anomaly"
  severity        String   // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  source          String   // IP, hostname, application
  destination     String?  // Target IP/system
  message         String   @db.Text
  details         Json?    // Structured event data
  timestamp       DateTime @default(now())
  processed       Boolean  @default(false)
  correlated      Boolean  @default(false)
  correlationId   String?  // Groups related events
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([eventType])
  @@index([severity])
  @@index([timestamp])
  @@index([correlationId])
  @@map("security_events")
}

model ThreatIntelligence {
  id              String   @id @default(cuid())
  iocType         String   // "ip", "domain", "hash", "url", "email"
  iocValue        String   // The actual IOC value
  threatType      String   // "malware", "phishing", "c2", "botnet"
  severity        String   // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  confidence      Int      // 0-100 confidence score
  source          String   // "internal", "external_feed", "manual"
  firstSeen       DateTime @default(now())
  lastSeen        DateTime @default(now())
  active          Boolean  @default(true)
  description     String?  @db.Text
  tags            Json?    // ["apt", "ransomware", etc]
  
  @@unique([iocType, iocValue])
  @@index([iocType])
  @@index([threatType])
  @@index([active])
  @@map("threat_intelligence")
}

model SecurityAlert {
  id              String   @id @default(cuid())
  userId          String
  title           String
  description     String   @db.Text
  severity        String   // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  status          String   @default("OPEN") // "OPEN", "INVESTIGATING", "RESOLVED", "FALSE_POSITIVE"
  alertType       String   // "anomaly", "correlation", "threat_match", "manual"
  sourceEventId   String?  // Related security event
  ruleId          String?  // Detection rule that triggered
  assignedTo      String?
  resolvedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([severity])
  @@index([status])
  @@index([alertType])
  @@map("security_alerts")
}

model DetectionRule {
  id              String   @id @default(cuid())
  userId          String
  name            String
  description     String   @db.Text
  ruleType        String   // "correlation", "threshold", "anomaly", "signature"
  conditions      Json     // Rule logic in JSON format
  severity        String   // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  enabled         Boolean  @default(true)
  lastTriggered   DateTime?
  triggerCount    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([enabled])
  @@index([ruleType])
  @@map("detection_rules")
}

model UserBehavior {
  id              String   @id @default(cuid())
  userId          String
  targetUserId    String   // User being monitored
  behaviorType    String   // "login_pattern", "data_access", "system_usage"
  baselineValue   Float    // Normal behavior baseline
  currentValue    Float    // Current observed value
  deviation       Float    // Percentage deviation from baseline
  riskScore       Int      // 0-100 risk assessment
  anomalyDetected Boolean  @default(false)
  timestamp       DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([targetUserId])
  @@index([anomalyDetected])
  @@index([timestamp])
  @@map("user_behaviors")
}

// Risk Management Models
model RiskAssessment {
  id              String   @id @default(cuid())
  userId          String
  title           String
  description     String   @db.Text
  category        String   // "operational", "financial", "cyber", "compliance", "strategic"
  probability     Float    // 0.0 - 1.0
  impact          Float    // 1-5 scale or monetary value
  riskScore       Float    // calculated: probability * impact
  inherentRisk    Float    // Risk before controls
  residualRisk    Float    // Risk after controls
  riskAppetite    Float    // Acceptable level of risk
  owner           String?  // Risk owner
  status          String   @default("OPEN") // "OPEN", "MITIGATING", "CLOSED", "ACCEPTED"
  dueDate         DateTime?
  lastReviewed    DateTime?
  nextReview      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  controls        RiskControl[]
  treatments      RiskTreatment[]
  
  @@index([userId])
  @@index([category])
  @@index([status])
  @@index([riskScore])
  @@map("risk_assessments")
}

model RiskControl {
  id              String   @id @default(cuid())
  riskId          String
  name            String
  description     String   @db.Text
  controlType     String   // "preventive", "detective", "corrective"
  effectiveness   Float    // 0.0 - 1.0
  implementationCost Float?
  maintenanceCost Float?
  implementedAt   DateTime?
  lastTested      DateTime?
  testResult      String?  // "PASS", "FAIL", "PARTIAL"
  responsible     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  risk            RiskAssessment @relation(fields: [riskId], references: [id], onDelete: Cascade)
  
  @@index([riskId])
  @@index([controlType])
  @@map("risk_controls")
}

model RiskTreatment {
  id              String   @id @default(cuid())
  riskId          String
  strategy        String   // "mitigate", "transfer", "avoid", "accept"
  action          String   @db.Text
  cost            Float?
  timeline        String?
  responsible     String?
  status          String   @default("PLANNED") // "PLANNED", "IN_PROGRESS", "COMPLETED"
  effectiveness   Float?   // Post-implementation assessment
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  risk            RiskAssessment @relation(fields: [riskId], references: [id], onDelete: Cascade)
  
  @@index([riskId])
  @@index([strategy])
  @@index([status])
  @@map("risk_treatments")
}

model BusinessImpactAnalysis {
  id              String   @id @default(cuid())
  userId          String
  assetName       String
  assetType       String   // "system", "process", "data", "facility"
  businessFunction String
  criticality     String   // "CRITICAL", "HIGH", "MEDIUM", "LOW"
  rto             Int?     // Recovery Time Objective (hours)
  rpo             Int?     // Recovery Point Objective (hours)
  mtpd            Int?     // Maximum Tolerable Period of Disruption
  financialImpact Json?    // {1h: 1000, 4h: 5000, 24h: 50000, 72h: 200000}
  operationalImpact String? @db.Text
  reputationalImpact String? @db.Text
  dependencies    Json?    // Array of dependent systems/processes
  alternatives    String?  @db.Text
  lastReviewed    DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([criticality])
  @@index([assetType])
  @@map("business_impact_analysis")
}

model ThirdPartyRisk {
  id              String   @id @default(cuid())
  userId          String
  vendorName      String
  vendorType      String   // "IT", "cloud", "financial", "logistics", "professional_services"
  contractValue   Float?
  criticality     String   // "CRITICAL", "HIGH", "MEDIUM", "LOW"
  dataAccess      Boolean  @default(false)
  systemAccess    Boolean  @default(false)
  geographicLocation String?
  certifications  Json?    // ["ISO27001", "SOC2", "PCI-DSS"]
  lastAssessment  DateTime?
  nextAssessment  DateTime?
  riskScore       Float    @default(0)
  securityRating  String?  // "A", "B", "C", "D", "F"
  complianceStatus String  @default("UNKNOWN") // "COMPLIANT", "NON_COMPLIANT", "UNDER_REVIEW", "UNKNOWN"
  contractEnd     DateTime?
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  assessments     ThirdPartyAssessment[]
  
  @@index([userId])
  @@index([criticality])
  @@index([riskScore])
  @@map("third_party_risks")
}

model ThirdPartyAssessment {
  id              String   @id @default(cuid())
  thirdPartyId    String
  assessmentType  String   // "initial", "annual", "incident", "contract_renewal"
  assessor        String
  questionnaire   Json     // Questions and answers
  findings        String?  @db.Text
  recommendations String?  @db.Text
  score           Float    // 0-100
  status          String   @default("IN_PROGRESS") // "IN_PROGRESS", "COMPLETED", "REMEDIATION_REQUIRED"
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  thirdParty      ThirdPartyRisk @relation(fields: [thirdPartyId], references: [id], onDelete: Cascade)
  
  @@index([thirdPartyId])
  @@index([assessmentType])
  @@index([status])
  @@map("third_party_assessments")
}

model MonteCarloSimulation {
  id              String   @id @default(cuid())
  userId          String
  name            String
  description     String?  @db.Text
  riskFactors     Json     // Array of risk factors with distributions
  iterations      Int      @default(10000)
  results         Json?    // Simulation results and statistics
  confidenceLevel Float    @default(0.95)
  var95           Float?   // Value at Risk 95%
  var99           Float?   // Value at Risk 99%
  expectedLoss    Float?
  worstCase       Float?
  bestCase        Float?
  runDate         DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([runDate])
  @@map("monte_carlo_simulations")
}

// ============ VULNERABILITY MANAGEMENT ============

model Vulnerability {
  id              String   @id @default(cuid())
  userId          String
  
  // Identificación
  cveId           String?  // CVE-2024-12345
  title           String
  description     String   @db.Text
  
  // Clasificación
  severity        String   // CRITICAL, HIGH, MEDIUM, LOW, INFO
  cvssScore       Float?   // 0.0 - 10.0
  cvssVector      String?  // CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
  cweId           String?  // CWE-79
  
  // Origen
  source          String   // scanner, pentest, bug_bounty, manual, external_feed
  scanId          String?  // Relacionado con un escaneo
  assetId         String?  // Activo afectado
  assetName       String?
  assetType       String?  // server, application, database, network
  
  // Estado
  status          String   @default("OPEN") // OPEN, IN_PROGRESS, REMEDIATED, ACCEPTED, FALSE_POSITIVE
  priority        String   @default("MEDIUM") // CRITICAL, HIGH, MEDIUM, LOW
  assignedTo      String?
  
  // Remediación
  remediation     String?  @db.Text
  remediationDue  DateTime?
  remediatedAt    DateTime?
  verifiedAt      DateTime?
  verifiedBy      String?
  
  // Fechas
  discoveredAt    DateTime @default(now())
  publishedAt     DateTime? // Fecha de publicación del CVE
  
  // Metadata
  references      Json?    // Array de URLs de referencia
  tags            Json?    // Array de tags
  exploitAvailable Boolean @default(false)
  patchAvailable  Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([severity])
  @@index([status])
  @@index([cveId])
  @@map("vulnerabilities_mgmt")
}

model VulnerabilityException {
  id              String   @id @default(cuid())
  userId          String
  vulnerabilityId String?
  
  // Detalle
  title           String
  reason          String   @db.Text // Justificación
  riskAcceptance  String?  @db.Text // Aceptación del riesgo
  
  // Aprobación
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED, EXPIRED
  approvedBy      String?
  approvedAt      DateTime?
  
  // Vigencia
  expiresAt       DateTime
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@map("vulnerability_exceptions")
}

// ============ COMPLIANCE AUTOMATION ============

model ComplianceFramework {
  id              String   @id @default(cuid())
  
  // Identificación
  name            String   // ISO 27001, SOC 2, GDPR, PCI-DSS, HIPAA
  version         String   // 2022, Type II, etc.
  description     String   @db.Text
  
  // Metadata
  category        String   // security, privacy, industry
  region          String?  // global, eu, us
  mandatory       Boolean  @default(false)
  
  // Estructura
  totalControls   Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  controls        ComplianceControl[]
  assessments     ComplianceAssessment[]
  
  @@unique([name, version])
  @@map("compliance_frameworks")
}

model ComplianceControl {
  id              String   @id @default(cuid())
  frameworkId     String
  
  // Identificación
  controlId       String   // A.5.1, CC1.1, Art.5
  title           String
  description     String   @db.Text
  
  // Categorización
  domain          String   // Access Control, Cryptography, etc.
  category        String?  // Technical, Administrative, Physical
  
  // Implementación
  objective       String?  @db.Text
  guidance        String?  @db.Text
  
  // Prioridad
  priority        String   @default("MEDIUM") // CRITICAL, HIGH, MEDIUM, LOW
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  framework       ComplianceFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  evidences       ComplianceEvidence[]
  
  @@unique([frameworkId, controlId])
  @@index([frameworkId])
  @@index([domain])
  @@map("compliance_controls")
}

model ComplianceAssessment {
  id              String   @id @default(cuid())
  userId          String
  frameworkId     String
  
  // Información
  name            String
  description     String?
  
  // Periodo
  assessmentDate  DateTime @default(now())
  periodStart     DateTime
  periodEnd       DateTime
  
  // Resultados
  status          String   @default("IN_PROGRESS") // PLANNED, IN_PROGRESS, COMPLETED, ARCHIVED
  overallScore    Float?   // 0-100
  compliantCount  Int      @default(0)
  partialCount    Int      @default(0)
  nonCompliantCount Int    @default(0)
  notApplicableCount Int   @default(0)
  
  // Auditoría
  auditorName     String?
  auditorCompany  String?
  findings        Json?    // Array de hallazgos
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  framework       ComplianceFramework @relation(fields: [frameworkId], references: [id])
  evidences       ComplianceEvidence[]
  
  @@index([userId])
  @@index([frameworkId])
  @@index([status])
  @@map("compliance_assessments")
}

model ComplianceEvidence {
  id              String   @id @default(cuid())
  userId          String
  assessmentId    String
  controlId       String
  
  // Estado del control
  status          String   // COMPLIANT, PARTIAL, NON_COMPLIANT, NOT_APPLICABLE
  
  // Evidencia
  evidenceType    String   // document, screenshot, config, log, policy
  title           String
  description     String?  @db.Text
  fileUrl         String?
  
  // Evaluación
  notes           String?  @db.Text
  gap             String?  @db.Text // Brecha identificada
  remediationPlan String?  @db.Text
  
  // Fechas
  collectedAt     DateTime @default(now())
  reviewedAt      DateTime?
  reviewedBy      String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  assessment      ComplianceAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  control         ComplianceControl @relation(fields: [controlId], references: [id])
  
  @@index([assessmentId])
  @@index([controlId])
  @@index([status])
  @@map("compliance_evidences")
}

// ============ BCP/DRP - Business Continuity & Disaster Recovery ============

model BusinessContinuityPlan {
  id              String   @id @default(cuid())
  userId          String
  
  // Información
  name            String
  version         String   @default("1.0")
  description     String   @db.Text
  
  // Alcance
  scope           String?  @db.Text
  objectives      Json?    // Array de objetivos
  
  // Métricas clave
  rto             Int?     // Recovery Time Objective (minutos)
  rpo             Int?     // Recovery Point Objective (minutos)
  mtpd            Int?     // Maximum Tolerable Period of Disruption (horas)
  
  // Estado
  status          String   @default("DRAFT") // DRAFT, REVIEW, APPROVED, ACTIVE, ARCHIVED
  approvedBy      String?
  approvedAt      DateTime?
  nextReviewDate  DateTime?
  
  // Documentación
  documentUrl     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  criticalProcesses CriticalProcess[]
  recoveryStrategies RecoveryStrategy[]
  bcpTests        BCPTest[]
  
  @@index([userId])
  @@index([status])
  @@map("business_continuity_plans")
}

model CriticalProcess {
  id              String   @id @default(cuid())
  bcpId           String
  
  // Información
  name            String
  description     String   @db.Text
  department      String?
  owner           String?
  
  // Clasificación
  criticality     String   // CRITICAL, HIGH, MEDIUM, LOW
  priority        Int      @default(1) // Orden de recuperación
  
  // Métricas
  rto             Int      // Recovery Time Objective (minutos)
  rpo             Int      // Recovery Point Objective (minutos)
  
  // Dependencias
  dependencies    Json?    // Array de dependencias (sistemas, personas, proveedores)
  resources       Json?    // Recursos necesarios
  
  // Impacto
  financialImpact Float?   // Impacto financiero por hora
  operationalImpact String? @db.Text
  reputationalImpact String? @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  bcp             BusinessContinuityPlan @relation(fields: [bcpId], references: [id], onDelete: Cascade)
  
  @@index([bcpId])
  @@index([criticality])
  @@map("critical_processes")
}

model RecoveryStrategy {
  id              String   @id @default(cuid())
  bcpId           String
  
  // Información
  name            String
  type            String   // HOT_SITE, WARM_SITE, COLD_SITE, CLOUD, MANUAL
  description     String   @db.Text
  
  // Detalles
  location        String?
  provider        String?
  contactInfo     Json?    // Información de contacto
  
  // Capacidad
  capacity        String?  // Descripción de capacidad
  activationTime  Int?     // Tiempo de activación (minutos)
  
  // Costos
  monthlyCost     Float?
  activationCost  Float?
  
  // Estado
  status          String   @default("PLANNED") // PLANNED, CONFIGURED, TESTED, ACTIVE
  lastTestedAt    DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  bcp             BusinessContinuityPlan @relation(fields: [bcpId], references: [id], onDelete: Cascade)
  
  @@index([bcpId])
  @@index([type])
  @@map("recovery_strategies")
}

model BCPTest {
  id              String   @id @default(cuid())
  bcpId           String
  
  // Información
  name            String
  type            String   // TABLETOP, WALKTHROUGH, SIMULATION, FULL
  description     String?  @db.Text
  
  // Planificación
  scheduledDate   DateTime
  
  // Ejecución
  status          String   @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED
  actualDate      DateTime?
  duration        Int?     // Duración en minutos
  
  // Participantes
  participants    Json?    // Array de participantes
  facilitator     String?
  
  // Resultados
  objectives      Json?    // Objetivos de la prueba
  results         Json?    // Resultados obtenidos
  rtoAchieved     Int?     // RTO real logrado
  rpoAchieved     Int?     // RPO real logrado
  successRate     Float?   // Porcentaje de éxito
  
  // Hallazgos
  findings        Json?    // Problemas encontrados
  lessonsLearned  String?  @db.Text
  recommendations String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  bcp             BusinessContinuityPlan @relation(fields: [bcpId], references: [id], onDelete: Cascade)
  
  @@index([bcpId])
  @@index([status])
  @@index([scheduledDate])
  @@map("bcp_tests")
}

model IncidentResponsePlan {
  id              String   @id @default(cuid())
  userId          String
  
  // Información
  name            String
  type            String   // cyber, natural, operational, pandemic
  description     String   @db.Text
  
  // Triggers
  triggerConditions Json?  // Condiciones que activan el plan
  escalationMatrix Json?   // Matriz de escalamiento
  
  // Fases
  phases          Json?    // Preparación, Detección, Contención, Erradicación, Recuperación, Lecciones
  
  // Contactos
  responseTeam    Json?    // Equipo de respuesta
  externalContacts Json?   // Contactos externos (proveedores, autoridades)
  
  // Comunicación
  communicationPlan Json?  // Plan de comunicación
  templates       Json?    // Plantillas de comunicación
  
  // Estado
  status          String   @default("DRAFT") // DRAFT, REVIEW, APPROVED, ACTIVE
  version         String   @default("1.0")
  approvedBy      String?
  approvedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([type])
  @@index([status])
  @@map("incident_response_plans")
}

